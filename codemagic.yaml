workflows:
  ios-workflow:
    name: iOS TestFlight Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      groups:
        - apple
      vars:
        BUNDLE_ID: com.orizg.lift14
    scripts:
      - name: Set up keychain to be active
        script: |
          keychain initialize
      - name: Fetch signing files (via Fastlane)
        script: |
          # Create an Auth Key file for Fastlane
          mkdir -p fastlane_auth
          cat > fastlane_auth/api_key.json <<EOF
          {
            "key_id": "$APP_STORE_CONNECT_KEY_IDENTIFIER",
            "issuer_id": "$APP_STORE_CONNECT_ISSUER_ID",
            "key": "$(echo "$APP_STORE_CONNECT_PRIVATE_KEY" | awk '{printf "%s\\n", $0}')",
            "in_house": false
          }
          EOF
          
          # Use Fastlane to "Cert" (Create/Fetch Certificate) and "Sigh" (Create/Fetch Profile)
          # This is more robust than the default wrapper
          gem install fastlane # Ensure latest
          fastlane run get_certificates type:"distribution" api_key_path:"fastlane_auth/api_key.json" generate_apple_certs:true
          fastlane run get_provisioning_profile app_identifier:"$BUNDLE_ID" type:"app-store" api_key_path:"fastlane_auth/api_key.json" generate_profiles:true
      - name: Use signing files
        script: |
          keychain add-certificates
      - name: Set up code signing settings on Xcode project
        script: |
          xcode-project use-profiles
      - name: Get Flutter dependencies
        script: |
          flutter packages pub get
      - name: Install CocoaPods dependencies
        script: |
          find . -name "Podfile" -exec dir {} \;
          cd ios && pod install
      - name: Build IPA
        script: |
          flutter build ipa --release --export-options-plist=/Users/builder/export_options.plist
      - name: Publish to TestFlight
        script: |
          app-store-connect publish --path $(find build/ios/ipa -name "*.ipa")
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
